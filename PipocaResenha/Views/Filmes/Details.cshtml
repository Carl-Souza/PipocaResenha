@model PipocaResenha.Models.Filmes
@{ Layout = "~/Views/Shared/_Layout.cshtml"; }

 <div class="row">
    <div class="col-md-4">
        @{
            var poster = string.IsNullOrEmpty(Model.PosterUrl) ? "https://via.placeholder.com/500x750?text=Sem+Imagem" : Model.PosterUrl;
        }
        <img src="@poster" class="img-fluid" alt="@Model.Titulo" />
    </div>
    <div class="col-md-8">
        <h2>@Model.Titulo</h2>
        <p><strong>Faixa etária:</strong> @Model.FaixaEtaria</p>
        <p><strong>Nota média:</strong> @(Model.Reviews.Any() ? Model.Reviews.Average(r => r.Nota) : 0)</p>
        <div class="card mt-3">
            <div class="card-body">
                <h5>Sinopse</h5>
                <p>@Model.Sinopse</p>
            </div>
        </div>
    </div>
</div>

<h3 class="mt-4">Cinemas</h3>
<div id="cinema-scrollable" data-filme-codigo="@Model.Codigo" style="height:300px; overflow:auto; border:1px solid #ddd; padding:10px;">
    <div id="cinema-list"></div>
</div>

@section Scripts {
<script>
let paginaCinema = 1;
let loadingCinemas = false;
let hasMoreCinemas = true;
// Gera URL correta usando Url.Action para evitar rota incorreta
const listaCinemasUrl = '@Url.Action("ListaCinemasParaFilmes", "Filmes")';

function renderCinemas(data){
    if (!data) return 0;
    if (typeof data === 'string') {
        // servidor retornou HTML parcial
        $('#cinema-list').append(data);
        // assume que retornou algo
        return data.trim() ? 1 : 0;
    }
    if (Array.isArray(data)) {
        if (data.length === 0) return 0;
        $('#cinema-list').append(data.map(c => `<div class="card mb-2"><div class='card-body'><h5>${c.nome}</h5><p>${c.endereco}</p></div></div>`).join(''));
        return data.length;
    }
    return 0;
}

function loadCinemas() {
    if (loadingCinemas || !hasMoreCinemas) return;
    loadingCinemas = true;
    // mostra spinner de carregamento
    $('#cinema-list').append('<div class="loading-spinner my-2 text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Carregando...</span></div></div>');
    const codigoFilme = $('#cinema-scrollable').data('filme-codigo');

    $.ajax({
        url: listaCinemasUrl,
        method: 'GET',
        data: { codigoFilme: codigoFilme, page: paginaCinema },
        // não forçamos dataType para aceitar JSON ou HTML parcial
    }).done(function(data){
        // remove spinner
        $('#cinema-list .loading-spinner').last().remove();

        const count = renderCinemas(data);
        if (count > 0) {
            paginaCinema++;
        } else {
            hasMoreCinemas = false;
            if (paginaCinema === 1) $('#cinema-list').append('<div class="text-muted">Nenhum cinema encontrado.</div>');
        }
    }).fail(function(jqXHR, textStatus, errorThrown){
        $('#cinema-list .loading-spinner').last().remove();
        $('#cinema-list').append(`<div class="text-danger">Erro ao carregar cinemas: ${textStatus}</div>`);
        // evita tentativas infinitas em caso de erro de servidor/rede
        hasMoreCinemas = false;
    }).always(function(){
        loadingCinemas = false;
    });
}

$('#cinema-scrollable').on('scroll', function(){
    var el = $(this)[0];
    if (el.scrollTop + el.clientHeight >= el.scrollHeight - 10) {
        loadCinemas();
    }
});
$(document).ready(loadCinemas);
</script>
}