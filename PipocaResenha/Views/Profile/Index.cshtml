@model PipocaResenha.Models.Usuarios
@{
    ViewData["Titulo"] = "Meu Perfil";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-5">
    <div class="row">
        <div class="col-md-4 text-center border-end border-secondary">
            <div class="mb-4 position-relative d-inline-block">
                <img src="@(string.IsNullOrEmpty(Model.PhotoUrl) ? "https://via.placeholder.com/150?text=Sem+Foto" : Model.PhotoUrl)"
                     class="rounded-circle img-thumbnail shadow"
                     style="width: 150px; height: 150px; object-fit: cover;"
                     alt="Foto de Perfil"
                     onerror="this.src='https://via.placeholder.com/150?text=Erro+Img'" />
            </div>

            <h3 class="fw-bold text-white">@Model.Nome</h3>
            <p class="text-muted">@Model.Email</p>

            <div class="d-grid gap-2 mt-4 px-4">
                <button type="button" class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditarPerfil">
                    ✏️ Editar Dados
                </button>

                <form asp-controller="Profile" asp-action="DeleteAccount" method="post" onsubmit="return confirm('Tem certeza absoluta? Todos os seus reviews serão apagados e essa ação não pode ser desfeita!');">
                    @Html.AntiForgeryToken() <button type="submit" class="btn btn-danger btn-sm w-100">
                        🗑️ Excluir Minha Conta
                    </button>
                </form>
            </div>
        </div>

        <div class="col-md-8 ps-md-5">
            <h4 class="border-bottom border-danger pb-2 mb-4 text-white">Meus Reviews</h4>

            <div id="reviews-container" style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                <div id="reviews-list">
                </div>

                <div id="loading-spinner" class="text-center py-3" style="display: none;">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>

                <div id="end-of-list" class="text-center text-muted py-3" style="display: none;">
                    <small>Você chegou ao fim dos seus reviews.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarPerfil" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Atualizar Perfil</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form asp-controller="Profile" asp-action="EditProfile" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-white-50">Nome de Exibição</label>
                        <input type="text" name="nome" class="form-control bg-black text-white border-secondary" value="@Model.Nome" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">URL da Foto</label>
                        <input type="url" name="photoUrl" class="form-control bg-black text-white border-secondary" value="@Model.PhotoUrl" placeholder="https://exemplo.com/foto.jpg" />
                        <small class="text-muted d-block mt-1">Dica: Use um link público de imagem (ex: Imgur, LinkedIn).</small>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ==============================================================
        // LÓGICA DE SCROLL INFINITO E REVIEWS
        // ==============================================================
        $(document).ready(function () {
            let pagina = 1;
            let carregando = false;
            let acabou = false;

            function carregarReviews() {
                if (carregando || acabou) return;

                carregando = true;
                $('#loading-spinner').show();

                $.get('/Profile/GetMyReviews', { page: pagina }, function (data) {
                    $('#loading-spinner').hide();

                    if (data && data.length > 0) {
                        let html = data.map(r => `
                            <div class="card mb-3 bg-dark border-secondary review-card" id="review-${r.codigo}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h5 class="card-title text-white mb-0">${r.tituloFilme}</h5>
                                            <span class="badge bg-warning text-dark mt-1">★ ${r.nota}</span>
                                        </div>
                                        <div class="btn-group">
                                            <a href="/Reviews/Edit?codigo=${r.codigo}" class="btn btn-sm btn-outline-light" title="Editar">✏️</a>
                                            <button onclick="excluirReview(${r.codigo})" class="btn btn-sm btn-outline-danger" title="Excluir">🗑️</button>
                                        </div>
                                    </div>
                                    <p class="card-text text-white-50 mt-3">"${r.texto}"</p>
                                </div>
                            </div>
                        `).join('');

                        $('#reviews-list').append(html);
                        pagina++;
                    } else {
                        acabou = true;
                        $('#end-of-list').show();
                    }
                    carregando = false;
                }).fail(function() {
                    carregando = false;
                    $('#loading-spinner').hide();
                });
            }

            // Inicia carregamento
            carregarReviews();

            // Detecta rolagem
            $('#reviews-container').on('scroll', function() {
                let div = $(this);
                if (div.scrollTop() + div.innerHeight() >= div[0].scrollHeight - 50) {
                    carregarReviews();
                }
            });
        });

        // Função de Excluir Review
        function excluirReview(codigo) {
            if(!confirm("Tem certeza que deseja excluir este review?")) return;

            $.post('/Reviews/Delete', { codigo: codigo }, function() {
                $(`#review-${codigo}`).fadeOut(300, function() { $(this).remove(); });
            }).fail(function() {
                alert("Erro ao excluir. Tente novamente.");
            });
        }
    </script>
}